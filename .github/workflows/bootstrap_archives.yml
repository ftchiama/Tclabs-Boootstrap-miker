name: üöÄ Build CodeStudio Bootstrap - FULL VERBOSE
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions: {}

jobs:
  build-bootstrap:
    runs-on: ubuntu-latest
    
    steps:
    # ========== ETAPA 1: VERIFICA√á√ÉO INICIAL ==========
    - name: üîç INIT - Verificar ambiente GitHub
      id: init_check
      run: |
        echo "================================================"
        echo "üîç INICIANDO VERIFICA√á√ÉO DO AMBIENTE"
        echo "================================================"
        echo "üìÖ Data/Hora: $(date)"
        echo "üíª Sistema: $(uname -a)"
        echo "üì¶ Mem√≥ria livre: $(free -h | awk '/^Mem:/{print $4}')"
        echo "üíæ Espa√ßo disco: $(df -h / | awk 'NR==2{print $4}')"
        echo "üê≥ Docker dispon√≠vel: $(command -v docker >/dev/null && echo 'SIM' || echo 'N√ÉO')"
        echo "üîß GitHub Runner: $RUNNER_OS ($RUNNER_ARCH)"
        echo "üìÅ Diret√≥rio atual: $(pwd)"
        echo "================================================"
        
        # Verificar se √© ambiente GitHub
        if [ -z "$GITHUB_ACTIONS" ]; then
          echo "‚ùå ERRO: N√£o est√° executando no GitHub Actions!"
          exit 1
        fi
        
        # Salvar informa√ß√µes para etapas posteriores
        echo "INIT_COMPLETE=true" >> $GITHUB_OUTPUT
        echo "WORKSPACE=$(pwd)" >> $GITHUB_OUTPUT
        
    # ========== ETAPA 2: CLONE DO REPOSIT√ìRIO ==========
    - name: üì• CLONE - Obter termux-packages
      id: clone_repo
      continue-on-error: true
      run: |
        echo "================================================"
        echo "üì• INICIANDO CLONE DO REPOSIT√ìRIO"
        echo "================================================"
        
        REPO_URL="https://github.com/agnostic-apollo/termux-packages.git"
        BRANCH="infra-improvs"
        
        echo "üîó Reposit√≥rio: $REPO_URL"
        echo "üåø Branch: $BRANCH"
        echo "üìÅ Alvo: ./termux-packages"
        
        # Tentativa 1: Clone direto
        echo "üîÑ Tentativa 1: Clone padr√£o..."
        if git clone --depth 1 --branch "$BRANCH" "$REPO_URL" ./termux-packages; then
          echo "‚úÖ Clone direto bem-sucedido!"
          CLONE_METHOD="direct"
        else
          echo "‚ö†Ô∏è Clone direto falhou, tentando m√©todo alternativo..."
          
          # Tentativa 2: Clone sem branch, depois checkout
          rm -rf ./termux-packages 2>/dev/null || true
          echo "üîÑ Tentativa 2: Clone + checkout..."
          if git clone --depth 1 "$REPO_URL" ./termux-packages && \
             cd ./termux-packages && \
             git fetch origin "$BRANCH" && \
             git checkout "$BRANCH"; then
            echo "‚úÖ Clone alternativo bem-sucedido!"
            CLONE_METHOD="alternative"
          else
            echo "‚ùå ERRO: Todos os m√©todos de clone falharam!"
            echo "üìä Status do √∫ltimo erro: $?"
            
            # Tentativa 3: Fallback para master
            echo "üîÑ Tentativa 3: Fallback para branch master..."
            rm -rf ./termux-packages 2>/dev/null || true
            if git clone --depth 1 https://github.com/termux/termux-packages.git ./termux-packages; then
              echo "‚ö†Ô∏è ATEN√á√ÉO: Usando branch master (pode ter bugs)"
              CLONE_METHOD="fallback_master"
            else
              echo "üí• ERRO CR√çTICO: N√£o foi poss√≠vel clonar o reposit√≥rio"
              exit 1
            fi
          fi
        fi
        
        # Verificar estrutura
        echo "üîç Verificando estrutura do reposit√≥rio..."
        if [ -d "./termux-packages/scripts" ] && [ -f "./termux-packages/scripts/properties.sh" ]; then
          echo "‚úÖ Estrutura v√°lida encontrada"
          REPO_VALID="true"
        else
          echo "‚ùå Estrutura inv√°lida! Conte√∫do:"
          ls -la ./termux-packages/ 2>/dev/null || echo "Diret√≥rio n√£o existe"
          REPO_VALID="false"
        fi
        
        # Salvar status
        echo "CLONE_METHOD=$CLONE_METHOD" >> $GITHUB_OUTPUT
        echo "REPO_VALID=$REPO_VALID" >> $GITHUB_OUTPUT
        echo "REPO_PATH=$(pwd)/termux-packages" >> $GITHUB_OUTPUT
        
    # ========== ETAPA 3: CONFIGURA√á√ÉO ==========
    - name: ‚öôÔ∏è CONFIG - Aplicar package name
      id: config_package
      run: |
        echo "================================================"
        echo "‚öôÔ∏è CONFIGURANDO PACKAGE NAME"
        echo "================================================"
        
        REPO_PATH="./termux-packages"
        PACKAGE_NAME="com.tclabs.codeStudio"
        
        if [ ! -f "$REPO_PATH/scripts/properties.sh" ]; then
          echo "‚ùå ERRO: Arquivo properties.sh n√£o encontrado em $REPO_PATH/scripts/"
          echo "üìÅ Conte√∫do de $REPO_PATH/scripts/:"
          ls -la "$REPO_PATH/scripts/" 2>/dev/null || echo "Diret√≥rio n√£o existe"
          exit 1
        fi
        
        # Backup do arquivo original
        cp "$REPO_PATH/scripts/properties.sh" "$REPO_PATH/scripts/properties.sh.backup"
        echo "üì¶ Backup criado: properties.sh.backup"
        
        # Substituir todas as ocorr√™ncias do package name
        echo "üîÑ Substituindo package names..."
        
        # Lista de padr√µes para substituir
        PATTERNS=(
          "com\.termux"
          "TERMUX_APP__PACKAGE_NAME=\"com.termux\""
          "TERMUX_APP_PACKAGE=\"com.termux\""
          "TERMUX_APP__PACKAGE_NAME=com.termux"
          "TERMUX_APP_PACKAGE=com.termux"
        )
        
        CHANGES=0
        for pattern in "${PATTERNS[@]}"; do
          echo "üîç Procurando: $pattern"
          if grep -q "$pattern" "$REPO_PATH/scripts/properties.sh"; then
            echo "  ‚úèÔ∏è  Substituindo: $pattern ‚Üí com.tclabs.codeStudio"
            sed -i "s|$pattern|com.tclabs.codeStudio|g" "$REPO_PATH/scripts/properties.sh"
            ((CHANGES++))
          else
            echo "  ‚è≠Ô∏è  Padr√£o n√£o encontrado"
          fi
        done
        
        # Adicionar se n√£o encontrou nenhum
        if [ "$CHANGES" -eq 0 ]; then
          echo "‚ö†Ô∏è Nenhuma substitui√ß√£o feita, adicionando manualmente..."
          echo "" >> "$REPO_PATH/scripts/properties.sh"
          echo "# ===== CODESTOUDIO CUSTOM CONFIG ======" >> "$REPO_PATH/scripts/properties.sh"
          echo "TERMUX_APP__PACKAGE_NAME=\"com.tclabs.codeStudio\"" >> "$REPO_PATH/scripts/properties.sh"
          echo "TERMUX_APP_PACKAGE=\"com.tclabs.codeStudio\"" >> "$REPO_PATH/scripts/properties.sh"
          CHANGES=2
        fi
        
        # Verificar resultado
        echo "‚úÖ $CHANGES altera√ß√µes realizadas"
        echo "üìÑ Conte√∫do final (√∫ltimas 20 linhas):"
        tail -20 "$REPO_PATH/scripts/properties.sh"
        
        echo "CONFIG_CHANGES=$CHANGES" >> $GITHUB_OUTPUT
        
    # ========== ETAPA 4: PREPARA√á√ÉO DO DOCKER ==========
    - name: üê≥ DOCKER - Preparar ambiente
      id: docker_setup
      run: |
        echo "================================================"
        echo "üê≥ PREPARANDO AMBIENTE DOCKER"
        echo "================================================"
        
        # Verificar se docker est√° dispon√≠vel
        echo "üîç Verificando Docker..."
        if command -v docker >/dev/null 2>&1; then
          DOCKER_VERSION=$(docker --version)
          echo "‚úÖ Docker encontrado: $DOCKER_VERSION"
          
          # Verificar permiss√µes
          if docker ps >/dev/null 2>&1; then
            echo "‚úÖ Permiss√µes Docker OK"
            DOCKER_READY="true"
          else
            echo "‚ö†Ô∏è Docker sem permiss√µes, tentando corrigir..."
            sudo groupadd docker 2>/dev/null || true
            sudo usermod -aG docker $USER 2>/dev/null || true
            sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
            
            # Tentar novamente
            if docker ps >/dev/null 2>&1; then
              echo "‚úÖ Permiss√µes corrigidas"
              DOCKER_READY="true"
            else
              echo "‚ùå N√£o foi poss√≠vel obter permiss√µes Docker"
              DOCKER_READY="false"
            fi
          fi
        else
          echo "‚ùå Docker n√£o encontrado no sistema"
          DOCKER_READY="false"
        fi
        
        # Fallback: usar container service do GitHub
        if [ "$DOCKER_READY" != "true" ]; then
          echo "üîÑ Fallback: Usando container service do GitHub..."
          # Verificar se estamos em container
          if [ -f /.dockerenv ]; then
            echo "‚úÖ J√° executando em container"
            DOCKER_READY="container"
          else
            echo "‚ö†Ô∏è Tentando usar docker do GitHub..."
            DOCKER_READY="github"
          fi
        fi
        
        echo "DOCKER_STATUS=$DOCKER_READY" >> $GITHUB_OUTPUT
        
    # ========== ETAPA 5: BUILD DO BOOTSTRAP ==========
    - name: üî® BUILD - Compilar bootstrap
      id: build_bootstrap
      continue-on-error: true
      run: |
        echo "================================================"
        echo "üî® INICIANDO BUILD DO BOOTSTRAP"
        echo "================================================"
        
        REPO_PATH="./termux-packages"
        BUILD_LOG="$REPO_PATH/build.log"
        
        # Limpar builds anteriores
        echo "üßπ Limpando builds anteriores..."
        find . -name "bootstrap-*.zip" -delete 2>/dev/null || true
        find . -name "codestudio-*.zip" -delete 2>/dev/null || true
        
        # Entrar no diret√≥rio
        cd "$REPO_PATH"
        echo "üìÅ Diret√≥rio de build: $(pwd)"
        
        # Verificar scripts
        echo "üîç Verificando scripts necess√°rios..."
        SCRIPTS=("build-bootstraps.sh" "run-docker.sh")
        for script in "${SCRIPTS[@]}"; do
          if [ -f "./scripts/$script" ]; then
            echo "  ‚úÖ $script encontrado"
            chmod +x "./scripts/$script" 2>/dev/null || true
          else
            echo "  ‚ùå $script N√ÉO encontrado!"
            echo "  üìÅ Conte√∫do de scripts/:"
            ls -la ./scripts/ 2>/dev/null || echo "Diret√≥rio n√£o existe"
          fi
        done
        
        # M√âTODO 1: Usar run-docker.sh
        echo "üîÑ M√âTODO 1: Executando via run-docker.sh..."
        if [ -f "./scripts/run-docker.sh" ] && [ -x "./scripts/run-docker.sh" ]; then
          echo "üìù Comando: ./scripts/run-docker.sh ./scripts/build-bootstraps.sh --architectures aarch64 --add bash --add apt -f"
          
          # Executar com timeout e logging
          timeout 1800 ./scripts/run-docker.sh ./scripts/build-bootstraps.sh \
            --architectures aarch64 \
            --add bash \
            --add apt \
            --add termux-tools \
            -f 2>&1 | tee "$BUILD_LOG" || {
              echo "‚ö†Ô∏è Timeout ou erro no m√©todo 1"
              BUILD_METHOD="run-docker-failed"
            }
          
          if [ -f "bootstrap-aarch64.zip" ]; then
            echo "‚úÖ M√âTODO 1 BEM-SUCEDIDO!"
            BUILD_METHOD="run-docker"
            BUILD_SUCCESS="true"
          else
            echo "‚ùå M√âTODO 1 FALHOU - Arquivo n√£o gerado"
            BUILD_METHOD="run-docker-failed"
            BUILD_SUCCESS="false"
          fi
        else
          echo "‚è≠Ô∏è M√©todo 1 n√£o dispon√≠vel"
          BUILD_METHOD="skip-1"
        fi
        
        # M√âTODO 2: Docker direto (fallback)
        if [ "$BUILD_SUCCESS" != "true" ]; then
          echo "üîÑ M√âTODO 2: Docker direto..."
          cd -
          cd "$REPO_PATH"
          
          echo "üìù Comando: docker run com volume montado"
          
          docker run --rm -v "$(pwd):/home/builder/termux-packages" \
            termux/package-builder \
            bash -c "
              echo 'üöÄ Iniciando build dentro do container...'
              echo 'üìÅ Diret√≥rio: \$(pwd)'
              echo 'üìÑ Conte√∫do:'
              ls -la scripts/ 2>/dev/null || echo 'scripts/ n√£o encontrado'
              
              if [ -f './scripts/build-bootstraps.sh' ]; then
                echo 'üî® Executando build-bootstraps.sh...'
                ./scripts/build-bootstraps.sh --architectures aarch64 --add bash --add apt -f
              else
                echo '‚ùå build-bootstraps.sh n√£o encontrado!'
                exit 1
              fi
            " 2>&1 | tee -a "$BUILD_LOG" || {
              echo "‚ö†Ô∏è Erro no m√©todo 2"
              BUILD_METHOD="docker-direct-failed"
            }
          
          if [ -f "bootstrap-aarch64.zip" ]; then
            echo "‚úÖ M√âTODO 2 BEM-SUCEDIDO!"
            BUILD_METHOD="docker-direct"
            BUILD_SUCCESS="true"
          else
            echo "‚ùå M√âTODO 2 FALHOU"
            BUILD_SUCCESS="false"
          fi
        fi
        
        # M√âTODO 3: GitHub container service (fallback extremo)
        if [ "$BUILD_SUCCESS" != "true" ] && [ "${{ steps.docker_setup.outputs.DOCKER_STATUS }}" == "github" ]; then
          echo "üîÑ M√âTODO 3: GitHub Container..."
          echo "‚ö†Ô∏è Executando em ambiente containerizado do GitHub"
          
          # Tentar executar diretamente
          if [ -f "./scripts/build-bootstraps.sh" ]; then
            chmod +x ./scripts/build-bootstraps.sh
            echo "üìù Executando build diretamente..."
            ./scripts/build-bootstraps.sh --architectures aarch64 --add bash --add apt -f 2>&1 | tee -a "$BUILD_LOG"
            
            if [ -f "bootstrap-aarch64.zip" ]; then
              echo "‚úÖ M√âTODO 3 BEM-SUCEDIDO!"
              BUILD_METHOD="github-direct"
              BUILD_SUCCESS="true"
            else
              echo "‚ùå M√âTODO 3 FALHOU"
              BUILD_SUCCESS="false"
            fi
          fi
        fi
        
        # Resultado final
        echo "================================================"
        echo "üìä RESULTADO DO BUILD"
        echo "================================================"
        echo "‚úÖ M√©todo usado: $BUILD_METHOD"
        echo "‚úÖ Sucesso: $BUILD_SUCCESS"
        echo "üìÅ Arquivos gerados:"
        ls -la *.zip 2>/dev/null || echo "Nenhum arquivo ZIP encontrado"
        
        # Verificar logs de erro
        if [ "$BUILD_SUCCESS" != "true" ] && [ -f "$BUILD_LOG" ]; then
          echo "‚ö†Ô∏è √öLTIMAS 50 LINHAS DO LOG DE ERRO:"
          tail -50 "$BUILD_LOG"
        fi
        
        echo "BUILD_METHOD=$BUILD_METHOD" >> $GITHUB_OUTPUT
        echo "BUILD_SUCCESS=$BUILD_SUCCESS" >> $GITHUB_OUTPUT
        
    # ========== ETAPA 6: P√ìS-PROCESSAMENTO ==========
    - name: üì¶ POST - Processar resultados
      id: post_process
      if: steps.build_bootstrap.outputs.BUILD_SUCCESS == 'true'
      run: |
        echo "================================================"
        echo "üì¶ PROCESSANDO RESULTADOS"
        echo "================================================"
        
        REPO_PATH="./termux-packages"
        cd "$REPO_PATH"
        
        # Renomear arquivos para identifica√ß√£o
        echo "üè∑Ô∏è Renomeando arquivos..."
        for zipfile in bootstrap-*.zip; do
          if [ -f "$zipfile" ]; then
            NEW_NAME="codestudio-${zipfile}"
            mv "$zipfile" "$NEW_NAME"
            echo "  ‚úÖ $zipfile ‚Üí $NEW_NAME"
            
            # Verificar conte√∫do
            echo "  üîç Conte√∫do de $NEW_NAME:"
            unzip -l "$NEW_NAME" | head -10 || echo "  ‚ö†Ô∏è N√£o foi poss√≠vel listar conte√∫do"
          fi
        done
        
        # Verificar estrutura interna
        echo "üîç Verificando estrutura interna do bootstrap..."
        if ls codestudio-*.zip 1>/dev/null 2>&1; then
          SAMPLE_ZIP=$(ls codestudio-*.zip | head -1)
          echo "üì¶ Arquivo de exemplo: $SAMPLE_ZIP"
          
          # Extrair e verificar paths
          TEMP_DIR=$(mktemp -d)
          unzip -q "$SAMPLE_ZIP" -d "$TEMP_DIR" 2>/dev/null || true
          
          if [ -d "$TEMP_DIR" ]; then
            echo "üìÅ Estrutura extra√≠da:"
            find "$TEMP_DIR" -type f -name "*.so" -o -name "*termux*" -o -name "*bash*" | head -20
            
            # Verificar package name nos arquivos
            echo "üîé Procurando refer√™ncias ao package name..."
            if find "$TEMP_DIR" -type f -exec grep -l "com.tclabs.codeStudio" {} \; 2>/dev/null | head -5; then
              echo "‚úÖ Package name correto encontrado nos arquivos"
            else
              echo "‚ö†Ô∏è Package name N√ÉO encontrado nos arquivos extra√≠dos"
            fi
            
            rm -rf "$TEMP_DIR"
          fi
        fi
        
        # Listar todos os arquivos finais
        echo "üìÑ ARQUIVOS FINAIS DISPON√çVEIS:"
        ls -lh *.zip 2>/dev/null || echo "Nenhum arquivo ZIP"
        
        # Contar arquivos
        ZIP_COUNT=$(ls *.zip 2>/dev/null | wc -l)
        echo "üìä Total de arquivos ZIP: $ZIP_COUNT"
        
        echo "ZIP_COUNT=$ZIP_COUNT" >> $GITHUB_OUTPUT
        
    # ========== ETAPA 7: UPLOAD ==========
    - name: ‚¨ÜÔ∏è UPLOAD - Enviar artefatos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: CodeStudio-Bootstrap-${{ github.run_id }}
        path: |
          termux-packages/codestudio-*.zip
          termux-packages/bootstrap-*.zip
          termux-packages/build.log
        retention-days: 7
        if-no-files-found: warn
        compression-level: 0
        
    # ========== ETAPA 8: RELAT√ìRIO FINAL ==========
    - name: üìã REPORT - Gerar relat√≥rio
      if: always()
      run: |
        echo "================================================"
        echo "üìã RELAT√ìRIO FINAL DO BUILD"
        echo "================================================"
        echo "üÜî Run ID: ${{ github.run_id }}"
        echo "üîó URL do Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "üìä STATUS DAS ETAPAS:"
        echo "  ‚úÖ Init: ${{ steps.init_check.outcome }}"
        echo "  ‚úÖ Clone: ${{ steps.clone_repo.outcome }} (M√©todo: ${{ steps.clone_repo.outputs.CLONE_METHOD }})"
        echo "  ‚úÖ Config: ${{ steps.config_package.outcome }} (${{ steps.config_package.outputs.CONFIG_CHANGES }} mudan√ßas)"
        echo "  ‚úÖ Docker: ${{ steps.docker_setup.outcome }} (Status: ${{ steps.docker_setup.outputs.DOCKER_STATUS }})"
        echo "  ‚úÖ Build: ${{ steps.build_bootstrap.outcome }} (Sucesso: ${{ steps.build_bootstrap.outputs.BUILD_SUCCESS }})"
        echo "  ‚úÖ Post: ${{ steps.post_process.outcome }}"
        echo ""
        
        if [ "${{ steps.build_bootstrap.outputs.BUILD_SUCCESS }}" = "true" ]; then
          echo "üéâ BUILD CONCLU√çDO COM SUCESSO!"
          echo "üì¶ Artefatos dispon√≠veis na aba 'Artifacts'"
          echo "üîß M√©todo usado: ${{ steps.build_bootstrap.outputs.BUILD_METHOD }}"
          echo ""
          echo "PR√ìXIMOS PASSOS:"
          echo "1. Baixe os arquivos da aba 'Artifacts'"
          echo "2. Copie para: termux-app/app/src/main/cpp/"
          echo "3. Modifique downloadBootstrap() no build.gradle"
          echo "4. Compile seu app CodeStudio"
        else
          echo "‚ùå BUILD FALHOU"
          echo ""
          echo "üìã PARA DEPURA√á√ÉO:"
          echo "1. Verifique logs completos acima"
          echo "2. Check se properties.sh foi modificado corretamente"
          echo "3. Verifique espa√ßo em disco e mem√≥ria"
          echo "4. Tente com apenas aarch64 primeiro"
        fi
        
        echo ""
        echo "================================================"
        echo "üèÅ FIM DO PROCESSO"
        echo "================================================"
