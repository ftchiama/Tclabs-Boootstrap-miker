name: üöÄ Build CodeStudio Bootstrap - FIXED
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # ========== ETAPA 1: CLONE CORRETO ==========
    - name: üì• Clone termux-packages
      run: |
        echo "========================================"
        echo "üì• CLONANDO REPOSIT√ìRIO"
        echo "========================================"
        
        # Limpar se existir
        rm -rf termux-packages 2>/dev/null || true
        
        # Clone da branch CORRETA
        git clone https://github.com/agnostic-apollo/termux-packages.git \
          --branch infra-improvs \
          --depth 1
        
        echo "‚úÖ Clone completo"
        ls -la termux-packages/
    
    # ========== ETAPA 2: CONFIGURA√á√ÉO SEGURA ==========
    - name: ‚öôÔ∏è Configurar package name
      run: |
        echo "========================================"
        echo "‚öôÔ∏è CONFIGURANDO PACKAGE NAME"
        echo "========================================"
        
        cd termux-packages
        
        # Backup
        cp scripts/properties.sh scripts/properties.sh.original
        
        echo "üìÑ Arquivo original (primeiras 50 linhas):"
        head -50 scripts/properties.sh
        
        # M√©todo SEGURO: usar awk para substituir APENAS as vari√°veis
        awk '
        /^TERMUX_APP__PACKAGE_NAME=/ { 
          if ($0 ~ /"com\.termux"/) {
            print "TERMUX_APP__PACKAGE_NAME=\"com.tclabs.codeStudio\""
            changes++
            next
          }
        }
        /^TERMUX_APP_PACKAGE=/ {
          if ($0 ~ /"com\.termux"/) {
            print "TERMUX_APP_PACKAGE=\"com.tclabs.codeStudio\""
            changes++
            next
          }
        }
        /^TERMUX_APP__PACKAGE_NAME="com.termux"/ {
          print "TERMUX_APP__PACKAGE_NAME=\"com.tclabs.codeStudio\""
          changes++
          next
        }
        /^TERMUX_APP_PACKAGE="com.termux"/ {
          print "TERMUX_APP_PACKAGE=\"com.tclabs.codeStudio\""
          changes++
          next
        }
        { print }
        END {
          if (changes == 0) {
            print "\n# ===== CODESTOUDIO CUSTOM CONFIG ====="
            print "TERMUX_APP__PACKAGE_NAME=\"com.tclabs.codeStudio\""
            print "TERMUX_APP_PACKAGE=\"com.tclabs.codeStudio\""
          }
        }
        ' scripts/properties.sh > scripts/properties.sh.new
        
        mv scripts/properties.sh.new scripts/properties.sh
        
        echo "‚úÖ Configura√ß√£o aplicada"
        echo "üìÑ Verifica√ß√£o:"
        grep -n "PACKAGE" scripts/properties.sh
        
    # ========== ETAPA 3: BUILD SIMPLES ==========
    - name: üî® Build bootstrap
      run: |
        echo "========================================"
        echo "üî® INICIANDO BUILD"
        echo "========================================"
        
        cd termux-packages
        
        # Verificar scripts
        echo "üîç Scripts dispon√≠veis:"
        ls -la scripts/build-*.sh scripts/*docker*.sh 2>/dev/null || true
        
        # M√©todo 1: run-docker.sh (preferido)
        if [ -f scripts/run-docker.sh ] && [ -x scripts/run-docker.sh ]; then
          echo "üöÄ Usando run-docker.sh..."
          timeout 1800 ./scripts/run-docker.sh ./scripts/build-bootstraps.sh \
            --architectures aarch64 \
            --add bash \
            --add apt \
            --add coreutils \
            -f 2>&1 | tee build.log
        else
          echo "‚ö†Ô∏è run-docker.sh n√£o encontrado, usando Docker direto..."
          docker run --rm -v $(pwd):/home/builder/termux-packages \
            termux/package-builder \
            ./scripts/build-bootstraps.sh --architectures aarch64 -f 2>&1 | tee build.log
        fi
        
        # Verificar resultado
        echo "üìä Resultado do build:"
        ls -la *.zip 2>/dev/null || echo "‚ö†Ô∏è Nenhum arquivo ZIP gerado"
        
        if ls bootstrap-*.zip 1>/dev/null 2>&1; then
          echo "‚úÖ BUILD SUCESSO!"
          # Renomear
          for f in bootstrap-*.zip; do
            mv "$f" "codestudio-${f}"
          done
        else
          echo "‚ùå BUILD FALHOU"
          echo "üìÑ √öltimas 100 linhas do log:"
          tail -100 build.log 2>/dev/null || echo "Log n√£o encontrado"
          exit 1
        fi
    
    # ========== ETAPA 4: VERIFICA√á√ÉO ==========
    - name: üîç Verificar bootstrap
      run: |
        echo "========================================"
        echo "üîç VERIFICANDO BOOTSTRAP"
        echo "========================================"
        
        cd termux-packages
        
        if ls codestudio-*.zip 1>/dev/null 2>&1; then
          ZIP_FILE=$(ls codestudio-*.zip | head -1)
          echo "üì¶ Arquivo: $ZIP_FILE"
          echo "üìè Tamanho: $(du -h "$ZIP_FILE" | cut -f1)"
          
          # Verificar conte√∫do b√°sico
          echo "üìÅ Estrutura interna:"
          unzip -l "$ZIP_FILE" | head -30
          
          # Verificar package name
          echo "üîé Procurando package name..."
          TEMP_DIR=$(mktemp -d)
          unzip -q "$ZIP_FILE" -d "$TEMP_DIR" 2>/dev/null || true
          
          if find "$TEMP_DIR" -type f -name "*.xml" -o -name "*.txt" -o -name "*.conf" | \
             xargs grep -l "com.tclabs.codeStudio" 2>/dev/null | head -5; then
            echo "‚úÖ Package name correto encontrado!"
          else
            echo "‚ö†Ô∏è Package name n√£o encontrado nos arquivos"
            echo "üìÑ Arquivos dispon√≠veis:"
            find "$TEMP_DIR" -type f | head -20
          fi
          
          rm -rf "$TEMP_DIR"
        else
          echo "‚ùå Nenhum arquivo bootstrap encontrado!"
          exit 1
        fi
    
    # ========== ETAPA 5: UPLOAD ==========
    - name: ‚¨ÜÔ∏è Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CodeStudio-Bootstrap
        path: termux-packages/codestudio-*.zip
        retention-days: 7
        if-no-files-found: error
    
    # ========== ETAPA 6: RELAT√ìRIO ==========
    - name: üìã Relat√≥rio final
      if: always()
      run: |
        echo "========================================"
        echo "üìã RELAT√ìRIO FINAL"
        echo "========================================"
        
        if [ -f "termux-packages/build.log" ]; then
          echo "üìä √öLTIMAS LINHAS DO LOG:"
          tail -20 termux-packages/build.log
        fi
        
        if ls termux-packages/codestudio-*.zip 1>/dev/null 2>&1; then
          echo "üéâ ‚úÖ BUILD CONCLU√çDO COM SUCESSO!"
          echo ""
          echo "üì¶ ARQUIVOS GERADOS:"
          ls -lh termux-packages/codestudio-*.zip
          echo ""
          echo "üöÄ PR√ìXIMOS PASSOS:"
          echo "1. Baixe os arquivos da aba 'Artifacts'"
          echo "2. Copie para: termux-app/app/src/main/cpp/"
          echo "3. Renomeie para: bootstrap-aarch64.zip, etc"
          echo "4. Modifique downloadBootstrap() no build.gradle para retornar early"
          echo "5. Compile seu app CodeStudio"
        else
          echo "‚ùå BUILD FALHOU"
          echo ""
          echo "üîß PARA DEPURA√á√ÉO:"
          echo "1. Verifique logs completos acima"
          echo "2. Confira se properties.sh tem as vari√°veis corretas:"
          grep "PACKAGE" termux-packages/scripts/properties.sh 2>/dev/null || echo "Arquivo n√£o encontrado"
        fi
