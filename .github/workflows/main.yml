name: Build Termux Bootstrap for CodeStudio

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-bootstrap:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 horas máximo
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Docker
      run: |
        # O GitHub Actions já tem Docker
        sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
        
    - name: Clone termux-packages (BRANCH CORRETA)
      run: |
        rm -rf termux-packages 2>/dev/null || true
        git clone --branch infra-improvs \
          --depth 1 \
          https://github.com/agnostic-apollo/termux-packages
          
    - name: Configure for CodeStudio
      run: |
        cd termux-packages
        
        # Backup original
        cp scripts/properties.sh scripts/properties.sh.backup
        
        # Substituir o nome do pacote
        sed -i 's/TERMUX_APP__PACKAGE_NAME="com\.termux"/TERMUX_APP__PACKAGE_NAME="com.tclabs.codestudio"/g' scripts/properties.sh
        sed -i 's/TERMUX_APP_PACKAGE="com\.termux"/TERMUX_APP_PACKAGE="com.tclabs.codestudio"/g' scripts/properties.sh
        
        # Verificar
        echo "=== CONFIGURAÇÃO VERIFICADA ==="
        grep -n "PACKAGE" scripts/properties.sh | grep -i "tclabs"
        
    - name: Clean previous builds
      run: |
        cd termux-packages
        ./scripts/run-docker.sh ./clean.sh
        
    - name: Build bootstrap for aarch64 (TESTE INICIAL)
      run: |
        cd termux-packages
        
        echo "=== INICIANDO COMPILAÇÃO ==="
        echo "Arquitetura: aarch64"
        echo "Pacote: com.tclabs.codestudio"
        
        # COMANDO CORRETO COM TODOS OS PARÂMETROS NECESSÁRIOS
        timeout 350m ./scripts/run-docker.sh ./scripts/build-bootstraps.sh \
          --architectures aarch64 \
          --no-build-unneeded-subpackages \
          -f \
          2>&1 | tee build.log
        
    - name: Check results
      run: |
        cd termux-packages
        
        if ls -la output/bootstrap-*.zip 2>/dev/null; then
          echo "✅ BOOTSTRAP GERADO COM SUCESSO!"
          echo "Arquivos encontrados:"
          ls -lh output/bootstrap-*.zip
        else
          echo "❌ FALHA NA GERAÇÃO"
          echo "Últimas 50 linhas do log:"
          tail -50 build.log || echo "Log não encontrado"
          exit 1
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bootstraps
        path: termux-packages/output/bootstrap-*.zip
