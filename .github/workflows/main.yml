name: tclabs bootstrap

on:
  workflow_dispatch:

permissions: {} # none

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    permissions:
      contents: read
    runs-on: ubuntu-slim
    env:
      TERMUX_APP_PACKAGE: "com.tclabs.codestudio"
      DEBUG_MODE: "true"
    strategy:
      matrix:
        arch:
          - aarch64
          - arm
          - i686
          - x86_64
    steps:
      - name: Git clone
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Debug - Show repository structure
        run: |
          echo "=== REPOSITORY STRUCTURE ==="
          echo "Checking key files..."
          ls -la scripts/*.sh 2>/dev/null | head -10
          echo ""
          echo "=== CHECKING PROPERTIES.SH ==="
          if [ -f "scripts/properties.sh" ]; then
            echo "✓ properties.sh exists"
            grep -n "TERMUX_APP__PACKAGE_NAME" scripts/properties.sh | head -2
          else
            echo "✗ ERROR: properties.sh not found!"
          fi
      
      - name: Fix critical permissions issue
        run: |
          echo "=== FIXING CRITICAL PERMISSIONS ISSUE ==="
          echo "Problem: /data/TERMUX_ARCH is owned by root, but script needs to write to it"
          echo "Solution: Create file with correct permissions from the start"
          
          # Create /data directory if not exists
          sudo mkdir -p /data
          
          # Create TERMUX_ARCH file with proper ownership and permissions
          echo "${{ matrix.arch }}" | sudo tee /data/TERMUX_ARCH
          
          # CRITICAL FIX: Change owner to runner user
          sudo chown runner:runner /data/TERMUX_ARCH
          
          # CRITICAL FIX: Give write permission to user
          sudo chmod 644 /data/TERMUX_ARCH
          
          echo "=== VERIFYING FIX ==="
          echo "File permissions:"
          ls -la /data/TERMUX_ARCH
          echo ""
          echo "Testing write access (as runner user):"
          if echo "test_write" > /data/TERMUX_ARCH 2>/dev/null; then
            echo "✓ SUCCESS: Can write to /data/TERMUX_ARCH"
            # Restore original content
            echo "${{ matrix.arch }}" > /data/TERMUX_ARCH
          else
            echo "✗ FAILED: Cannot write to /data/TERMUX_ARCH"
            echo "Trying alternative fix..."
            sudo chmod 666 /data/TERMUX_ARCH
            ls -la /data/TERMUX_ARCH
          fi
          
          echo ""
          echo "Testing read access:"
          if cat /data/TERMUX_ARCH >/dev/null 2>&1; then
            echo "✓ SUCCESS: Can read /data/TERMUX_ARCH"
            echo "Content: $(cat /data/TERMUX_ARCH)"
          else
            echo "✗ FAILED: Cannot read /data/TERMUX_ARCH"
          fi
      
      - name: Create app directories
        run: |
          echo "=== CREATING APP DIRECTORIES ==="
          
          # Create basic Android app directory structure
          sudo mkdir -p /data/data/com.tclabs.codestudio
          sudo mkdir -p /data/data/com.tclabs.codestudio/files
          sudo mkdir -p /data/data/com.tclabs.codestudio/cache
          sudo mkdir -p /data/data/com.tclabs.codestudio/termux
          
          # Set proper ownership
          sudo chown -R runner:runner /data/data 2>/dev/null || true
          sudo chmod -R 755 /data/data 2>/dev/null || true
          
          echo "Directory structure created:"
          find /data -type d 2>/dev/null | sort
      
      - name: Analyze the problematic script
        run: |
          echo "=== ANALYZING termux_step_handle_buildarch.sh ==="
          
          if [ -f "scripts/build/termux_step_handle_buildarch.sh" ]; then
            echo "File exists. Line count: $(wc -l < scripts/build/termux_step_handle_buildarch.sh)"
            echo ""
            echo "=== LINES AROUND LINE 33 ==="
            sed -n '25,35p' scripts/build/termux_step_handle_buildarch.sh
            echo ""
            echo "=== FULL FILE CONTENT ==="
            cat scripts/build/termux_step_handle_buildarch.sh
            echo ""
            echo "=== ANALYSIS ==="
            echo "The script defines TERMUX_ARCH_FILE=/data/TERMUX_ARCH"
            echo "At line 33 it tries to write: echo \"\$TERMUX_ARCH\" > \$TERMUX_ARCH_FILE"
            echo "This requires write permission to /data/TERMUX_ARCH"
          else
            echo "✗ ERROR: scripts/build/termux_step_handle_buildarch.sh not found!"
          fi
      
      - name: Apply patch if needed (optional)
        run: |
          echo "=== APPLYING OPTIONAL PATCH ==="
          echo "This step patches the script to avoid writing to /data/TERMUX_ARCH"
          
          SCRIPT_FILE="scripts/build/termux_step_handle_buildarch.sh"
          if [ -f "$SCRIPT_FILE" ]; then
            # Backup original
            cp "$SCRIPT_FILE" "${SCRIPT_FILE}.backup"
            
            # Check if line 33 exists and contains the problematic write
            if sed -n '33p' "$SCRIPT_FILE" | grep -q 'echo.*TERMUX_ARCH.*>' ; then
              echo "Found problematic write at line 33. Patching..."
              
              # Option 1: Comment out the line
              sed -i '33s/^/# /' "$SCRIPT_FILE"
              
              # Option 2: Replace with a no-op (safer)
              # sed -i '33s/echo "$TERMUX_ARCH" > $TERMUX_ARCH_FILE/# echo "$TERMUX_ARCH" > $TERMUX_ARCH_FILE  # Disabled for GitHub Actions/' "$SCRIPT_FILE"
              
              echo "Patch applied. New line 33:"
              sed -n '33p' "$SCRIPT_FILE"
            else
              echo "Line 33 doesn't contain the problematic write. Skipping patch."
              echo "Line 33 content:"
              sed -n '33p' "$SCRIPT_FILE"
            fi
          else
            echo "Script file not found, skipping patch."
          fi
      
      - name: Pre-build test
        run: |
          echo "=== PRE-BUILD TEST ==="
          echo "Testing if build-bootstraps.sh can be sourced without errors..."
          
          # Test sourcing properties.sh
          if . scripts/properties.sh 2>&1; then
            echo "✓ properties.sh sourced successfully"
          else
            echo "✗ Failed to source properties.sh"
            . scripts/properties.sh 2>&1 || true
          fi
          
          # Test sourcing termux_step_handle_buildarch.sh
          if . scripts/build/termux_step_handle_buildarch.sh 2>&1; then
            echo "✓ termux_step_handle_buildarch.sh sourced successfully"
          else
            echo "✗ Failed to source termux_step_handle_buildarch.sh"
            . scripts/build/termux_step_handle_buildarch.sh 2>&1 || true
          fi
          
          echo ""
          echo "=== FINAL PERMISSION CHECK ==="
          echo "/data/TERMUX_ARCH permissions:"
          ls -la /data/TERMUX_ARCH
          echo "Can write? $(echo "test" > /data/TERMUX_ARCH 2>/dev/null && echo "YES" || echo "NO")"
          echo "Can read? $(cat /data/TERMUX_ARCH >/dev/null 2>&1 && echo "YES" || echo "NO")"
      
      - name: Create bootstrap archive
        timeout-minutes: 60
        run: |
          echo "=== STARTING BOOTSTRAP BUILD ==="
          echo "Architecture: ${{ matrix.arch }}"
          echo "Package: $TERMUX_APP_PACKAGE"
          echo "Working directory: $(pwd)"
          echo ""
          
          echo "=== EXECUTING build-bootstraps.sh ==="
          echo "Command: ./scripts/build-bootstraps.sh --architectures ${{ matrix.arch }}"
          
          # Enable verbose output
          set -x
          
          # Execute the build script
          ./scripts/build-bootstraps.sh --architectures "${{ matrix.arch }}"
          
          BUILD_EXIT_CODE=$?
          set +x
          
          echo ""
          echo "=== BUILD COMPLETED ==="
          echo "Exit code: $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "✓ BUILD SUCCESSFUL"
            echo ""
            echo "=== GENERATED FILES ==="
            ls -la *.zip 2>/dev/null || echo "No zip files found (but build succeeded?)"
          else
            echo "✗ BUILD FAILED with exit code $BUILD_EXIT_CODE"
            echo ""
            echo "=== ERROR ANALYSIS ==="
            echo "Last error was likely from termux_step_handle_buildarch.sh"
            echo "Check if /data/TERMUX_ARCH permissions are correct"
          fi
          
          # Exit with the build's exit code
          exit $BUILD_EXIT_CODE
      
      - name: Debug - Post-build analysis
        if: failure()
        run: |
          echo "=== POST-BUILD DEBUG ANALYSIS ==="
          echo ""
          echo "=== CURRENT STATE ==="
          echo "Working directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          
          echo ""
          echo "=== /data DIRECTORY STATUS ==="
          find /data -type f 2>/dev/null || echo "No files in /data"
          
          echo ""
          echo "=== CHECKING /data/TERMUX_ARCH ==="
          if [ -f "/data/TERMUX_ARCH" ]; then
            echo "File exists"
            echo "Permissions: $(ls -la /data/TERMUX_ARCH)"
            echo "Owner: $(stat -c '%U:%G' /data/TERMUX_ARCH)"
            echo "Content: $(cat /data/TERMUX_ARCH)"
          else
            echo "File does not exist!"
          fi
          
          echo ""
          echo "=== SCRIPT PATCH STATUS ==="
          if [ -f "scripts/build/termux_step_handle_buildarch.sh" ]; then
            echo "Line 33 content:"
            sed -n '33p' scripts/build/termux_step_handle_buildarch.sh
          fi
      
      - name: Store artifacts
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: bootstrap-archives-${{ matrix.arch }}-${{ github.sha }}
          path: "*.zip"
          retention-days: 7
      
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "=== CLEANUP ==="
          echo "Removing any generated files..."
          rm -f *.zip *.tmp *.log 2>/dev/null || true
  
  publish:
    permissions:
      contents: write
    needs: build
    runs-on: ubuntu-slim
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "Build job status: ${{ needs.build.result }}"
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Skipping publish because build failed"
            exit 0
          fi
      
      - name: Git clone
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Fetch bootstrap archives
        uses: actions/download-artifact@v7
        with:
          merge-multiple: true
          path: ./
      
      - name: Verify downloaded artifacts
        run: |
          echo "=== VERIFYING ARTIFACTS ==="
          ZIP_COUNT=$(find . -name "*.zip" -type f | wc -l)
          echo "Found $ZIP_COUNT zip files"
          
          if [ "$ZIP_COUNT" -eq 0 ]; then
            echo "ERROR: No zip files found!"
            exit 1
          fi
          
          echo "Listing zip files:"
          find . -name "*.zip" -type f -exec ls -la {} \;
      
      - name: Create new tag
        id: get_tag
        run: |
          echo "=== CREATING NEW TAG ==="
          new_tag="bootstrap-$(date "+%Y.%m.%d")"
          echo "Base tag: $new_tag"
          
          # Check for existing tags
          existing_tag_revision=$(git tag | grep "$new_tag" | sort -r | head -n 1 | cut -d- -f3 | cut -dr -f2)
          
          if [ -n "$existing_tag_revision" ]; then
            tag_rev=$((existing_tag_revision + 1))
          else
            tag_rev=1
          fi
          
          new_tag="${new_tag}-r${tag_rev}+apt.android-7"
          echo "New tag: $new_tag"
          echo "tag_name=$new_tag" >> $GITHUB_OUTPUT
      
      - name: Setup GitHub CLI
        run: |
          echo "=== SETTING UP GITHUB CLI ==="
          # Install GitHub CLI if not present
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            sudo apt-get update
            sudo apt-get install -y gh
          fi
          gh --version
      
      - name: Publish bootstrap zips to GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "=== PUBLISHING RELEASE ==="
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Tag: ${{ steps.get_tag.outputs.tag_name }}"
          
          # Create release
          echo "Creating release..."
          gh release create "${{ steps.get_tag.outputs.tag_name }}" \
            --title "Bootstrap archives for CodeStudio application (apt.android-7)" \
            --notes "Automatically generated bootstrap archives" \
            --draft=false \
            --prerelease=false
          
          # Upload all zip files
          echo "Uploading files..."
          for file in *.zip; do
            if [ -f "$file" ]; then
              echo "Uploading: $file"
              gh release upload "${{ steps.get_tag.outputs.tag_name }}" "$file" --clobber
            fi
          done
          
          echo "Release created successfully"
      
      - name: Cleanup workspace
        run: |
          echo "=== CLEANING WORKSPACE ==="
          rm -f *.zip 2>/dev/null || true
          echo "Cleanup complete"
