name: tclabs bootstrap3

on:
  workflow_dispatch:

permissions: {} # none

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    permissions:
      contents: read
    runs-on: ubuntu-slim
    env:
      TERMUX_APP_PACKAGE: "com.tclabs.codestudio"
      DEBUG_MODE: "true"
    strategy:
      matrix:
        arch:
          - aarch64
          - arm
          - i686
          - x86_64
    steps:
      - name: Git clone
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Debug - Show repository structure
        run: |
          echo "=== REPOSITORY STRUCTURE ==="
          find . -type f -name "*.sh" | grep -E "(bootstrap|build|properties)" | head -20
          echo ""
          echo "=== SCRIPTS DIRECTORY ==="
          ls -la scripts/
          echo ""
          echo "=== SCRIPTS/BUILD DIRECTORY ==="
          ls -la scripts/build/ || echo "No scripts/build directory"
          echo ""
          echo "=== CHECK PROPERTIES.SH ==="
          if [ -f "scripts/properties.sh" ]; then
            echo "properties.sh exists"
            grep -n "TERMUX_APP__PACKAGE_NAME" scripts/properties.sh || echo "Not found in properties.sh"
          else
            echo "ERROR: properties.sh not found!"
          fi
      
      - name: Setup build environment
        run: |
          echo "=== STARTING ENVIRONMENT SETUP ==="
          echo "Current user: $(whoami)"
          echo "Current directory: $(pwd)"
          echo "Matrix arch: ${{ matrix.arch }}"
          echo "TERMUX_APP_PACKAGE: $TERMUX_APP_PACKAGE"
          
          echo ""
          echo "=== CHECKING /data DIRECTORY ==="
          ls -la / | grep data || echo "/data does not exist"
          
          echo ""
          echo "=== CREATING /data STRUCTURE ==="
          sudo mkdir -p /data
          echo "Created /data directory"
          ls -la / | grep data
          
          echo ""
          echo "=== CREATING /data/TERMUX_ARCH ==="
          echo "${{ matrix.arch }}" | sudo tee /data/TERMUX_ARCH
          echo "File created at /data/TERMUX_ARCH"
          echo "Content: $(sudo cat /data/TERMUX_ARCH)"
          sudo chmod 644 /data/TERMUX_ARCH
          echo "Permissions: $(sudo ls -la /data/TERMUX_ARCH)"
          
          echo ""
          echo "=== CREATING APP DIRECTORIES ==="
          sudo mkdir -p /data/data/com.tclabs.codestudio
          sudo mkdir -p /data/data/com.tclabs.codestudio/files
          sudo mkdir -p /data/data/com.tclabs.codestudio/cache
          sudo mkdir -p /data/data/com.tclabs.codestudio/termux
          
          echo ""
          echo "=== SETTING PERMISSIONS ==="
          sudo chown -R $USER:$USER /data/data 2>/dev/null || true
          sudo chmod -R 755 /data/data 2>/dev/null || true
          
          echo ""
          echo "=== FINAL /data STRUCTURE ==="
          find /data -type d 2>/dev/null | sort
          
          echo ""
          echo "=== CHECKING ENVIRONMENT VARIABLES ==="
          env | grep -i termux || echo "No TERMUX environment variables"
      
      - name: Debug - Check termux_step_handle_buildarch.sh
        run: |
          echo "=== ANALYZING termux_step_handle_buildarch.sh ==="
          if [ -f "scripts/build/termux_step_handle_buildarch.sh" ]; then
            echo "File exists"
            echo ""
            echo "=== LINE 33 (THE PROBLEMATIC LINE) ==="
            sed -n '30,36p' scripts/build/termux_step_handle_buildarch.sh
            echo ""
            echo "=== FULL FILE ANALYSIS ==="
            echo "Total lines: $(wc -l < scripts/build/termux_step_handle_buildarch.sh)"
            grep -n "/data/TERMUX_ARCH" scripts/build/termux_step_handle_buildarch.sh || echo "No /data/TERMUX_ARCH references"
          else
            echo "ERROR: scripts/build/termux_step_handle_buildarch.sh not found!"
            echo "Looking for it..."
            find . -name "termux_step_handle_buildarch.sh" -type f
          fi
      
      - name: Debug - Check build-bootstraps.sh dependencies
        run: |
          echo "=== ANALYZING build-bootstraps.sh ==="
          if [ -f "scripts/build-bootstraps.sh" ]; then
            echo "File exists"
            echo ""
            echo "=== SOURCED FILES ==="
            grep -n "\. \|source " scripts/build-bootstraps.sh | head -10
            
            echo ""
            echo "=== FIRST 20 LINES ==="
            head -20 scripts/build-bootstraps.sh
            
            echo ""
            echo "=== CHECKING IF PROPERTIES.SH IS LOADED CORRECTLY ==="
            if grep -q "properties.sh" scripts/build-bootstraps.sh; then
              echo "properties.sh is referenced in build-bootstraps.sh"
            else
              echo "WARNING: properties.sh not referenced in build-bootstraps.sh"
            fi
          else
            echo "ERROR: scripts/build-bootstraps.sh not found!"
            ls scripts/*.sh
          fi
      
      - name: Test file access
        run: |
          echo "=== TESTING FILE ACCESS ==="
          echo "Testing /data/TERMUX_ARCH access..."
          if [ -f "/data/TERMUX_ARCH" ]; then
            echo "File exists"
            echo "Content: $(cat /data/TERMUX_ARCH)"
            echo "Permissions: $(ls -la /data/TERMUX_ARCH)"
          else
            echo "ERROR: /data/TERMUX_ARCH does not exist!"
          fi
          
          echo ""
          echo "Testing if user can read /data/TERMUX_ARCH..."
          cat /data/TERMUX_ARCH && echo "SUCCESS: Can read file" || echo "ERROR: Cannot read file"
          
          echo ""
          echo "=== TESTING PROPERTIES.SH ==="
          if [ -f "scripts/properties.sh" ]; then
            echo "Testing if properties.sh can be sourced..."
            if . scripts/properties.sh 2>&1; then
              echo "SUCCESS: properties.sh sourced successfully"
            else
              echo "ERROR: Failed to source properties.sh"
              . scripts/properties.sh 2>&1 || true
            fi
          fi
      
      - name: Create bootstrap archive
        timeout-minutes: 60
        run: |
          echo "=== STARTING BOOTSTRAP BUILD ==="
          echo "Current directory: $(pwd)"
          echo "Running: ./scripts/build-bootstraps.sh --architectures ${{ matrix.arch }}"
          echo ""
          echo "=== PRE-BUILD ENVIRONMENT ==="
          echo "PATH: $PATH"
          echo "USER: $(whoami)"
          echo "HOME: $HOME"
          echo "PWD: $(pwd)"
          echo ""
          echo "=== CHECKING REQUIRED TOOLS ==="
          for cmd in ar awk curl grep gzip find sed tar xargs xz zip; do
            if command -v $cmd >/dev/null 2>&1; then
              echo "✓ $cmd: $(which $cmd)"
            else
              echo "✗ $cmd: NOT FOUND"
            fi
          done
          
          echo ""
          echo "=== EXECUTING build-bootstraps.sh ==="
          set -x  # Enable debug output for the actual build
          ./scripts/build-bootstraps.sh --architectures ${{ matrix.arch }}
          BUILD_EXIT_CODE=$?
          set +x
          
          echo ""
          echo "=== BUILD COMPLETED ==="
          echo "Exit code: $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "✓ BUILD SUCCESSFUL"
            echo ""
            echo "=== GENERATED FILES ==="
            ls -la *.zip 2>/dev/null || echo "No zip files generated"
          else
            echo "✗ BUILD FAILED"
            echo "Last 50 lines of potential output (if any):"
            find . -name "*.log" -type f -exec tail -50 {} \; 2>/dev/null || echo "No log files found"
          fi
          
          exit $BUILD_EXIT_CODE
      
      - name: Debug - Post-build analysis
        if: failure()
        run: |
          echo "=== POST-BUILD DEBUG ANALYSIS ==="
          echo ""
          echo "=== CHECKING FOR ERROR LOGS ==="
          find . -type f -name "*.log" -o -name "*.tmp" -o -name "*.err" | while read file; do
            echo "=== $file ==="
            tail -100 "$file" 2>/dev/null | head -50
            echo ""
          done
          
          echo ""
          echo "=== CURRENT DIRECTORY CONTENTS ==="
          ls -la
          
          echo ""
          echo "=== /data DIRECTORY STATUS ==="
          find /data -type f 2>/dev/null | head -20
          
          echo ""
          echo "=== CHECKING FOR PARTIAL BOOTSTRAP FILES ==="
          find . -type f -name "bootstrap-*" -o -name "*.zip" | while read file; do
            echo "Found: $file"
            ls -la "$file"
          done
      
      - name: Store artifacts
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: bootstrap-archives-${{ matrix.arch }}-${{ github.sha }}
          path: "*.zip"
          retention-days: 7
      
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "=== CLEANUP ==="
          echo "Removing any generated files..."
          rm -f *.zip *.tmp *.log 2>/dev/null || true
  
  publish:
    permissions:
      contents: write
    needs: build
    runs-on: ubuntu-slim
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "Build job status: ${{ needs.build.result }}"
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Skipping publish because build failed"
            exit 0
          fi
      
      - name: Git clone
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Fetch bootstrap archives
        uses: actions/download-artifact@v7
        with:
          merge-multiple: true
          path: ./
      
      - name: Verify downloaded artifacts
        run: |
          echo "=== VERIFYING ARTIFACTS ==="
          echo "Current directory: $(pwd)"
          ls -la
          echo ""
          echo "=== ZIP FILES ==="
          find . -name "*.zip" -type f | while read zip; do
            echo "File: $zip"
            echo "Size: $(du -h "$zip" | cut -f1)"
            echo "Checksum: $(sha256sum "$zip" | cut -d' ' -f1)"
            echo ""
          done
          
          # Check if we have any zip files
          if [ -z "$(find . -name '*.zip' -type f)" ]; then
            echo "ERROR: No zip files found!"
            exit 1
          fi
      
      - name: Create new tag
        id: get_tag
        run: |
          echo "=== CREATING NEW TAG ==="
          new_tag="bootstrap-$(date "+%Y.%m.%d")"
          echo "Base tag: $new_tag"
          
          # Check for existing tags
          existing_tag_revision=$(git tag | grep "$new_tag" | sort -r | head -n 1 | cut -d- -f3 | cut -dr -f2)
          echo "Existing tag revision: $existing_tag_revision"
          
          if [ -n "$existing_tag_revision" ]; then
            tag_rev=$((existing_tag_revision + 1))
          else
            tag_rev=1
          fi
          
          new_tag="${new_tag}-r${tag_rev}+apt.android-7"
          echo "New tag: $new_tag"
          echo "tag_name=$new_tag" >> $GITHUB_OUTPUT
      
      - name: Setup GitHub CLI
        run: |
          echo "=== SETTING UP GITHUB CLI ==="
          gh --version || echo "GitHub CLI not installed"
          # Install if not present
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install -y gh
          fi
      
      - name: Publish bootstrap zips to GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "=== PUBLISHING RELEASE ==="
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Tag: ${{ steps.get_tag.outputs.tag_name }}"
          echo ""
          
          # Create release
          echo "Creating release..."
          gh release create "${{ steps.get_tag.outputs.tag_name }}" \
            --title "Bootstrap archives for CodeStudio application (apt.android-7)" \
            --notes "Automatically generated bootstrap archives for ${{ github.sha }}" \
            --draft=false \
            --prerelease=false
          
          # Upload all zip files
          echo ""
          echo "Uploading files..."
          for file in *.zip; do
            if [ -f "$file" ]; then
              echo "Uploading: $file"
              gh release upload "${{ steps.get_tag.outputs.tag_name }}" "$file" --clobber
            else
              echo "WARNING: $file not found"
            fi
          done
          
          echo ""
          echo "=== RELEASE CREATED SUCCESSFULLY ==="
          echo "Release URL: https://github.com/$GITHUB_REPOSITORY/releases/tag/${{ steps.get_tag.outputs.tag_name }}"
      
      - name: Cleanup workspace
        run: |
          echo "=== CLEANING WORKSPACE ==="
          rm -f *.zip 2>/dev/null || true
          echo "Cleanup complete"
