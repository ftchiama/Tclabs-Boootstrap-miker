name: TCLabs_Debug_Deep_Log
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write

    steps:
      - name: 1. Limpeza Extrema e Log de Espaço Inicial
        run: |
          set -x
          echo "=== ESPAÇO INICIAL ==="
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/lib/mono /usr/local/lib/node_modules /opt/hostedtoolcache/CodeQL
          docker image prune -a -f
          echo "=== ESPAÇO APÓS LIMPEZA ==="
          df -h

      - name: 2. Checkout com Log
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 3. Configuração do Pacote (Modo Verboso)
        run: |
          set -x
          # Altera o pacote para com.tclabs.codestudio
          sed -i 's/TERMUX_APP_PACKAGE="com.termux"/TERMUX_APP_PACKAGE="com.tclabs.codestudio"/g' ./scripts/properties.sh
          
          # Verifica se a alteração foi gravada
          grep "TERMUX_APP_PACKAGE" ./scripts/properties.sh
          
          # Reduz a lista de pacotes para o mínimo essencial (Versão 0.65 leve)
          # Isso evita compilar ferramentas pesadas que lotam o disco
          sed -i 's/TERMUX_PKGS_TO_INSTALL=.*/TERMUX_PKGS_TO_INSTALL="bash,coreutils,dash,diffutils,findutils,gawk,grep,sed,tar,termux-exec,termux-tools,util-linux,apt,ca-certificates,dpkg,readline"/g' ./scripts/build-bootstraps.sh

      - name: 4. Execução do Build (Log Intensivo)
        run: |
          # Ativa o log para o ambiente do runner
          set -x
          
          # O script abaixo entra no Docker e compila. 
          # Adicionamos 'bash -x' para ver o que acontece dentro do script de build
          ./scripts/run-docker.sh bash -x ./scripts/build-bootstraps.sh --architectures aarch64

      - name: 5. Verificação de Arquivos Gerados
        if: always()
        run: |
          set -x
          echo "=== CONTEÚDO DO DIRETÓRIO FINAL ==="
          ls -R
          df -h

      - name: 6. Upload e Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: "*.zip"
          tag_name: v1.0-tclabs-${{ github.run_id }}
          name: "Bootstrap TCLabs Final"
          body: "Compilado com log intensivo para o pacote com.tclabs.codestudio"
        env:
          GITHUB_TOKEN: ${{ github.token }}

